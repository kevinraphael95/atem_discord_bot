<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YGO Price Duel</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body { width:100%;height:100%;font-family:'Nunito',sans-serif;background:#0d0d14;overflow:hidden;color:#fff;user-select:none; }

#header { position:fixed;top:0;left:0;right:0;height:54px;z-index:100;display:flex;align-items:center;justify-content:space-between;padding:0 24px;background:rgba(5,5,12,0.9);backdrop-filter:blur(12px);border-bottom:1px solid rgba(255,255,255,0.08); }
.logo { font-size:1.05rem;font-weight:900;color:#fff;display:flex;align-items:center;gap:8px; }
.logo em { color:#ffd166;font-style:normal; }
.hud { display:flex;align-items:center;gap:20px; }
.hud-item { display:flex;flex-direction:column;align-items:center;line-height:1; }
.hud-val { font-size:1.1rem;font-weight:900;color:#ffd166; }
.hud-lbl { font-size:0.44rem;font-weight:700;text-transform:uppercase;letter-spacing:0.14em;color:rgba(255,255,255,0.3);margin-top:2px; }

#game { position:fixed;top:54px;left:0;right:0;bottom:0;display:flex;flex-direction:row; }
.panel { flex:1;position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:hidden; }
.panel-bg { position:absolute;inset:-20px;background-size:cover;background-position:center;opacity:0.08;filter:blur(24px);pointer-events:none; }

#divider { width:2px;background:rgba(255,255,255,0.08);position:relative;flex-shrink:0;z-index:10; }
#vs-badge { position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:44px;height:44px;border-radius:50%;background:#0d0d14;border:2px solid rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center;font-size:0.6rem;font-weight:900;letter-spacing:0.1em;color:rgba(255,255,255,0.35); }

.card-wrap { width:clamp(130px,17vw,210px);height:clamp(130px,17vw,210px);border-radius:50%;overflow:hidden;border:3px solid rgba(255,255,255,0.14);box-shadow:0 8px 40px rgba(0,0,0,0.7);background:#1a1a2e;position:relative;flex-shrink:0; }
.card-wrap img { position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center; }
.card-wrap .spinner { position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:2.4rem;background:linear-gradient(135deg,#12122a,#1e1e40);animation:pulse 1.5s ease-in-out infinite; }
.card-wrap .spinner.gone { display:none; }
@keyframes pulse { 0%,100%{opacity:0.7}50%{opacity:1} }

.panel-info { display:flex;flex-direction:column;align-items:center;text-align:center;margin-top:16px;padding:0 12px;max-width:290px; }
.eyebrow { font-size:0.5rem;font-weight:700;letter-spacing:0.22em;text-transform:uppercase;color:rgba(255,255,255,0.3);margin-bottom:6px; }
.card-name { font-size:clamp(0.88rem,1.9vw,1.3rem);font-weight:900;color:#fff;line-height:1.15;margin-bottom:3px; }
.card-type { font-size:0.6rem;font-weight:600;color:rgba(255,255,255,0.3);margin-bottom:12px;letter-spacing:0.05em; }
.is-label { font-size:0.65rem;font-weight:700;text-transform:uppercase;letter-spacing:0.14em;color:rgba(255,255,255,0.28);margin-bottom:4px; }
.price-val { font-size:clamp(1.7rem,3.8vw,2.8rem);font-weight:900;color:#fff;line-height:1;letter-spacing:-0.02em; }
.price-val.hidden { color:rgba(255,255,255,0.18);letter-spacing:0.35em;font-size:clamp(1.3rem,2.8vw,2rem); }
.price-source { font-size:0.48rem;font-weight:700;letter-spacing:0.15em;text-transform:uppercase;color:rgba(255,255,255,0.22);margin-top:4px; }

.btn-zone { display:flex;flex-direction:column;gap:9px;margin-top:16px; }
.btn-guess { padding:11px 24px;border-radius:8px;border:none;font-family:'Nunito',sans-serif;font-size:clamp(0.72rem,1.4vw,0.85rem);font-weight:800;letter-spacing:0.06em;text-transform:uppercase;cursor:pointer;transition:all 0.15s;min-width:154px;display:flex;align-items:center;justify-content:center;gap:6px; }
.btn-higher { background:#c93046;color:#fff;box-shadow:0 4px 18px rgba(201,48,70,0.5); }
.btn-higher:hover:not(:disabled) { background:#e03a55;transform:translateY(-2px);box-shadow:0 6px 24px rgba(201,48,70,0.65); }
.btn-lower { background:#3a47d4;color:#fff;box-shadow:0 4px 18px rgba(58,71,212,0.5); }
.btn-lower:hover:not(:disabled) { background:#4d5ae8;transform:translateY(-2px);box-shadow:0 6px 24px rgba(58,71,212,0.65); }
.btn-guess:disabled { opacity:0.3;cursor:not-allowed;transform:none !important;box-shadow:none !important; }
.btn-guess.correct { background:#06d6a0 !important;box-shadow:0 4px 18px rgba(6,214,160,0.5) !important; }
.btn-guess.wrong { background:#383838 !important;box-shadow:none !important;opacity:0.6; }

#lives { position:fixed;bottom:18px;left:50%;transform:translateX(-50%);z-index:100;display:flex;gap:8px; }
.life { width:9px;height:9px;border-radius:50%;background:#fff;box-shadow:0 0 7px rgba(255,255,255,0.5);transition:all 0.3s; }
.life.lost { background:rgba(255,255,255,0.12);box-shadow:none; }

#toast { position:fixed;top:66px;left:50%;transform:translateX(-50%) translateY(-10px);background:rgba(8,8,18,0.96);backdrop-filter:blur(14px);border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:10px 22px;font-size:0.82rem;font-weight:800;letter-spacing:0.05em;text-transform:uppercase;z-index:200;opacity:0;pointer-events:none;transition:opacity 0.2s,transform 0.2s;white-space:nowrap;max-width:90vw;text-align:center; }
#toast.show { opacity:1;transform:translateX(-50%) translateY(0); }
#toast.ok { color:#06d6a0;border-color:rgba(6,214,160,0.3); }
#toast.ko { color:#ef233c;border-color:rgba(239,35,60,0.25); }

/* Countdown bar */
#countdown { position:fixed;bottom:0;left:0;right:0;height:3px;z-index:200;display:none; }
#countdown-fill { height:100%;width:100%;background:linear-gradient(90deg,#e8b84b,#ffd166);transform-origin:left center;transform:scaleX(1); }

/* Loading screen */
#loading {
  position:fixed;inset:0;z-index:600;
  background:#0d0d14;
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;
}
.loading-logo { font-size:2rem;font-weight:900; }
.loading-logo em { color:#ffd166;font-style:normal; }
.loading-bar-wrap { width:220px;height:4px;background:rgba(255,255,255,0.1);border-radius:99px;overflow:hidden; }
.loading-bar { height:100%;background:linear-gradient(90deg,#e8b84b,#ffd166);border-radius:99px;width:0%;transition:width 0.3s; }
.loading-txt { font-size:0.65rem;font-weight:700;letter-spacing:0.16em;text-transform:uppercase;color:rgba(255,255,255,0.35); }

#gameover { position:fixed;inset:0;z-index:500;background:rgba(5,5,12,0.97);backdrop-filter:blur(20px);display:none;flex-direction:column;align-items:center;justify-content:center;gap:22px;text-align:center;padding:32px; }
#gameover.show { display:flex;animation:goIn 0.4s ease; }
@keyframes goIn { from{opacity:0;transform:scale(0.95)}to{opacity:1;transform:scale(1)} }
.go-emoji { font-size:3.5rem; }
.go-title { font-size:clamp(3rem,8vw,5.5rem);font-weight:900;color:#ef233c;letter-spacing:-0.02em;filter:drop-shadow(0 0 28px rgba(239,35,60,0.45));line-height:1; }
.go-sub { font-size:0.7rem;font-weight:700;letter-spacing:0.2em;text-transform:uppercase;color:rgba(255,255,255,0.28); }
.go-stats { display:flex;gap:24px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:18px;padding:20px 36px; }
.go-stat { text-align:center; }
.go-stat-v { font-size:2.5rem;font-weight:900;color:#ffd166;line-height:1; }
.go-stat-l { font-size:0.5rem;font-weight:700;letter-spacing:0.16em;text-transform:uppercase;color:rgba(255,255,255,0.28);margin-top:4px; }
.go-sep { width:1px;background:rgba(255,255,255,0.08); }
.go-replay { padding:14px 40px;background:linear-gradient(135deg,#e8b84b,#ffd166);color:#111;font-family:'Nunito',sans-serif;font-size:1rem;font-weight:900;letter-spacing:0.08em;text-transform:uppercase;border:none;border-radius:999px;cursor:pointer;box-shadow:0 4px 24px rgba(255,209,102,0.4);transition:transform 0.15s; }
.go-replay:hover { transform:scale(1.05); }
</style>
</head>
<body>

<!-- LOADING SCREEN -->
<div id="loading">
  <div class="loading-logo">âš¡ <em>YGO</em> Price Duel</div>
  <div class="loading-bar-wrap"><div class="loading-bar" id="loadingBar"></div></div>
  <div class="loading-txt" id="loadingTxt">Chargement des prix...</div>
</div>

<div id="header">
  <div class="logo">âš¡ <em>YGO</em> Price Duel</div>
  <div class="hud">
    <div class="hud-item"><span class="hud-val" id="hRecord">0</span><span class="hud-lbl">Record</span></div>
    <div class="hud-item"><span class="hud-val" id="hScore">0</span><span class="hud-lbl">Score</span></div>
    <div class="hud-item"><span class="hud-val" id="hStreak" style="color:#f59e0b">0ğŸ”¥</span><span class="hud-lbl">SÃ©rie</span></div>
  </div>
</div>

<div id="game">
  <div class="panel" id="panelA">
    <div class="panel-bg" id="bgA"></div>
    <div class="card-wrap">
      <img id="imgA" src="" alt="">
      <div class="spinner" id="spinA">ğŸƒ</div>
    </div>
    <div class="panel-info">
      <div class="eyebrow">Carte A Â· Prix connu</div>
      <div class="card-name" id="nameA">â€”</div>
      <div class="card-type" id="typeA"></div>
      <div class="is-label">vaut</div>
      <div class="price-val" id="priceA">â€”</div>
      <div class="price-source">Cardmarket</div>
    </div>
  </div>

  <div id="divider"><div id="vs-badge">VS</div></div>

  <div class="panel" id="panelB">
    <div class="panel-bg" id="bgB"></div>
    <div class="card-wrap">
      <img id="imgB" src="" alt="">
      <div class="spinner" id="spinB">ğŸƒ</div>
    </div>
    <div class="panel-info">
      <div class="eyebrow">Carte B Â· Devinez</div>
      <div class="card-name" id="nameB">â€”</div>
      <div class="card-type" id="typeB"></div>
      <div class="is-label">est</div>
      <div class="price-val hidden" id="priceB">?</div>
      <div class="price-source">Cardmarket</div>
      <div class="btn-zone">
        <button class="btn-guess btn-higher" id="btnH" onclick="guess('higher')">â†‘ Plus cher</button>
        <button class="btn-guess btn-lower"  id="btnL" onclick="guess('lower')">â†“ Moins cher</button>
      </div>
    </div>
  </div>
</div>

<div id="lives"></div>
<div id="toast"></div>
<div id="countdown"><div id="countdown-fill"></div></div>

<div id="gameover">
  <div class="go-emoji">ğŸ’€</div>
  <div class="go-title">Game Over</div>
  <div class="go-sub">Tu as Ã©puisÃ© tes vies</div>
  <div class="go-stats">
    <div class="go-stat"><div class="go-stat-v" id="goScore">0</div><div class="go-stat-l">Score final</div></div>
    <div class="go-sep"></div>
    <div class="go-stat"><div class="go-stat-v" id="goBest">0</div><div class="go-stat-l">Record</div></div>
  </div>
  <button class="go-replay" onclick="restart()">â†© Rejouer</button>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LISTE DE NOMS â€” l'API rÃ©cupÃ¨re les vrais prix
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const CARD_NAMES = [
  "Maxx \"C\"", "Graceful Charity", "Baronne de Fleur",
  "Exodia the Forbidden One", "Painful Choice", "Accesscode Talker",
  "Blue-Eyes White Dragon", "Sixth Sense", "Forbidden Droplet",
  "Delinquent Duo", "Pot of Prosperity", "Harpie's Feather Duster",
  "Lightning Storm", "Crystron Halqifibrax", "Triple Tactics Talent",
  "Pot of Greed", "Nibiru, the Primal Being", "Tearlaments Kitkallos",
  "Infinite Impermanence", "Crossout Designator", "I:P Masquerena",
  "True King of All Calamities", "Ash Blossom & Joyous Spring",
  "Dark Magician", "Apollousa, Bow of the Goddess", "Raigeki",
  "Imperial Order", "Divine Arsenal AA-ZEUS - Sky Thunder",
  "Red-Eyes Black Dragon", "Droll & Lock Bird", "Borreload Savage Dragon",
  "Chaos Emperor Dragon - Envoy of the End", "Predaplant Verte Anaconda",
  "Pot of Extravagance", "Spright Elf", "Jinzo",
  "Pot of Desires", "Solemn Judgment", "Eldlich the Golden Lord",
  "Gigantic Spright", "Black Luster Soldier - Envoy of the Beginning",
  "Ghost Ogre & Snow Rabbit", "Toadally Awesome",
  "Hieratic Seal of the Heavenly Spheres", "Monster Reborn",
  "Solemn Strike", "Vanity's Emptiness", "Dimensional Barrier",
  "Skill Drain", "Mirror Force", "Effect Veiler", "Solemn Warning",
  "Number 41: Bagooska the Terribly Tired Tapir", "Knightmare Unicorn",
  "Foolish Burial", "Abyss Dweller", "Thunder King Rai-Oh",
  "Cyber Dragon", "Book of Moon", "Dark Hole", "Mystical Space Typhoon",
  "Called by the Grave", "Ghost Belle & Haunted Mansion",
  "Number 39: Utopia", "Number S39: Utopia the Lightning",
  "Tornado Dragon", "Naturia Beast", "Borreload Dragon",
  "Firewall Dragon", "Knightmare Phoenix", "Knightmare Cerberus",
  "Linkuriboh", "Salamangreat Almiraj", "I:P Masquerena",
  "Nibiru, the Primal Being", "Triple Tactics Thrust",
  "Pot of Prosperity", "Gameciel, the Sea Turtle Kaiju",
  "Interrupting Kaiju", "Prank-Kids Meow-Meow-Mu",
  "Spright Blue", "Spright Jet", "Tearlaments Scheiren",
  "Tearlaments Reinoheart", "Floowandereeze & Robina",
  "Floowandereeze & Stri", "Branded Fusion", "Albaz the Ashen",
  "Springans Kitt", "Sprind the Irondash Dragon"
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHARGEMENT API
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let DECK_BASE = [];

async function fetchCards() {
  const bar = document.getElementById('loadingBar');
  const txt = document.getElementById('loadingTxt');

  // On envoie par batches de 10 noms (sÃ©parÃ©s par |) pour limiter les appels
  const BATCH = 10;
  const results = [];
  const batches = [];
  for(let i = 0; i < CARD_NAMES.length; i += BATCH) {
    batches.push(CARD_NAMES.slice(i, i + BATCH));
  }

  for(let b = 0; b < batches.length; b++) {
    // Cartes une par une â€” l'API YGOPRODeck supporte CORS mais le sÃ©parateur |
    // est mal gÃ©rÃ© depuis le navigateur, on fait une requÃªte par carte
    for(const name of batches[b]) {
      try {
        const url = `https://db.ygoprodeck.com/api/v7/cardinfo.php?name=${encodeURIComponent(name)}`;
        const resp = await fetch(url, { mode: 'cors' });
        if(!resp.ok) continue;
        const json = await resp.json();
        if(!json.data?.[0]) continue;
        const card  = json.data[0];
        const price = parseFloat(card.card_prices?.[0]?.cardmarket_price || '0');
        const img   = card.card_images?.[0];
        if(price > 0 && img) {
          results.push({
            name:    card.name,
            type:    card.type,
            id:      img.id,
            imgCrop: img.image_url_cropped || img.image_url_small || img.image_url,
            price:   price
          });
        }
        await sleep(55); // ~18 req/s, sous le rate limit de 20/s
      } catch(e) {
        console.warn('Card failed:', name, e.message);
      }
    }

    // Update loading bar
    const pct = Math.round(((b + 1) / batches.length) * 100);
    bar.style.width = pct + '%';
    txt.textContent = `Chargement ${Math.min(results.length, 999)} cartes... ${pct}%`;
  }

  // DÃ©duplique par id, garde uniquement les cartes avec prix diffÃ©rents entre elles
  const seen = new Set();
  for(const c of results) {
    if(!seen.has(c.id)) { seen.add(c.id); DECK_BASE.push(c); }
  }

  // Filtre les cartes avec prix nul ou trop proche de 0
  DECK_BASE = DECK_BASE.filter(c => c.price >= 0.05);

  txt.textContent = `${DECK_BASE.length} cartes chargÃ©es !`;
  await sleep(500);

  // Cache en sessionStorage pour Ã©viter de re-fetcher si rechargement rapide
  try {
    sessionStorage.setItem('ygo_deck_cache', JSON.stringify(DECK_BASE));
  } catch(e) {}

  return DECK_BASE.length >= 4;
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function shuffle(a) {
  const b=[...a];
  for(let i=b.length-1;i>0;i--){const j=Math.random()*(i+1)|0;[b[i],b[j]]=[b[j],b[i]];}
  return b;
}

function loadImg(side, card) {
  const img  = document.getElementById('img'  + side);
  const spin = document.getElementById('spin' + side);
  const bg   = document.getElementById('bg'   + side);
  img.style.opacity = '0';
  spin.classList.remove('gone');

  const cropped = card.imgCrop;
  const fallback = `https://images.ygoprodeck.com/images/cards/${card.id}.jpg`;

  function tryUrl(url, fb) {
    const tmp = new Image();
    tmp.onload = () => {
      img.src = url;
      img.style.opacity = '1';
      spin.classList.add('gone');
      bg.style.backgroundImage = `url('${url}')`;
    };
    tmp.onerror = fb;
    tmp.src = url;
  }

  tryUrl(cropped, () => tryUrl(fallback, () => {
    spin.textContent = 'ğŸƒ';
    spin.style.animation = 'none';
  }));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const MAX_LIVES = 5;
const DELAY_MS  = 2200;

let best = +localStorage.getItem('ygo_best_v9') || 0;
let deck = [], ptr = 0;
let cardA, cardB;
let score = 0, streak = 0, lives = MAX_LIVES;
let answered = false;
let autoTimer = null;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HUD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderHUD() {
  document.getElementById('hScore').textContent  = score;
  document.getElementById('hRecord').textContent = best;
  document.getElementById('hStreak').textContent = streak > 0 ? `${streak}ğŸ”¥` : '0';
  const livesEl = document.getElementById('lives');
  livesEl.innerHTML = '';
  for(let i=0;i<MAX_LIVES;i++){
    const d=document.createElement('div');
    d.className='life'+(i>=lives?' lost':'');
    livesEl.appendChild(d);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setPanel(side, card, showPrice) {
  loadImg(side, card);
  document.getElementById('name'+side).textContent  = card.name;
  document.getElementById('type'+side).textContent  = card.type;
  const pEl = document.getElementById('price'+side);
  if(showPrice) { pEl.className='price-val'; pEl.textContent=`â‚¬${card.price.toFixed(2)}`; }
  else          { pEl.className='price-val hidden'; pEl.textContent='?'; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PICK
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function pick() {
  if(ptr+1>=deck.length){ deck=shuffle(DECK_BASE); ptr=0; }
  let a=deck[ptr], b=deck[ptr+1], tries=0;
  while(Math.abs(a.price - b.price) < 0.05 && tries<30){
    ptr++;
    if(ptr+1>=deck.length){deck=shuffle(DECK_BASE);ptr=0;}
    b=deck[ptr+1]; tries++;
  }
  cardA=a; cardB=b; ptr+=2;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NEXT ROUND
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function nextRound() {
  clearTimeout(autoTimer);
  answered = false;
  stopCountdown();
  const btnH=document.getElementById('btnH');
  const btnL=document.getElementById('btnL');
  btnH.disabled=false; btnL.disabled=false;
  btnH.className='btn-guess btn-higher';
  btnL.className='btn-guess btn-lower';
  pick();
  setPanel('A', cardA, true);
  setPanel('B', cardB, false);
  renderHUD();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COUNTDOWN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startCountdown(ms) {
  const wrap=document.getElementById('countdown');
  const fill=document.getElementById('countdown-fill');
  wrap.style.display='block';
  fill.style.transition='none';
  fill.style.transform='scaleX(1)';
  fill.getBoundingClientRect();
  fill.style.transition=`transform ${ms}ms linear`;
  fill.style.transform='scaleX(0)';
  autoTimer=setTimeout(()=>{ stopCountdown(); nextRound(); }, ms);
}
function stopCountdown() {
  clearTimeout(autoTimer);
  const wrap=document.getElementById('countdown');
  const fill=document.getElementById('countdown-fill');
  wrap.style.display='none';
  fill.style.transition='none';
  fill.style.transform='scaleX(1)';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let toastTimer;
function showToast(msg,type) {
  const t=document.getElementById('toast');
  t.textContent=msg; t.className='show '+type;
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>{t.className='';},3000);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GUESS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function guess(choice) {
  if(answered) return;
  answered=true;
  const btnH=document.getElementById('btnH');
  const btnL=document.getElementById('btnL');
  btnH.disabled=true; btnL.disabled=true;

  const pEl=document.getElementById('priceB');
  pEl.className='price-val';
  pEl.textContent=`â‚¬${cardB.price.toFixed(2)}`;

  const correct = cardB.price > cardA.price ? 'higher' : 'lower';
  const ok = (choice===correct);

  if(choice==='higher'){
    btnH.className='btn-guess '+(ok?'correct':'wrong');
    if(!ok) btnL.className='btn-guess correct';
  } else {
    btnL.className='btn-guess '+(ok?'correct':'wrong');
    if(!ok) btnH.className='btn-guess correct';
  }

  if(ok) {
    score++; streak++;
    if(score>best){best=score;localStorage.setItem('ygo_best_v9',best);}
    const diff=Math.abs(cardA.price-cardB.price).toFixed(2);
    const s=streak>=3?` Â· ğŸ”¥ Ã—${streak}`:'';
    showToast(`âœ“ Correct !  Ã‰cart : â‚¬${diff}${s}`,'ok');
  } else {
    streak=0; lives--;
    const winner=cardA.price>cardB.price?cardA:cardB;
    showToast(`âœ— RatÃ© !  ${winner.name} = â‚¬${Math.max(cardA.price,cardB.price).toFixed(2)}`,'ko');
  }

  renderHUD();
  if(lives<=0){ setTimeout(gameOver,1600); }
  else        { startCountdown(DELAY_MS); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAME OVER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function gameOver() {
  stopCountdown();
  document.getElementById('goScore').textContent=score;
  document.getElementById('goBest').textContent=best;
  document.getElementById('gameover').classList.add('show');
}

function restart() {
  score=streak=0; lives=MAX_LIVES; answered=false; ptr=0;
  deck=shuffle(DECK_BASE);
  document.getElementById('gameover').classList.remove('show');
  renderHUD();
  nextRound();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function init() {
  // VÃ©rifie le cache session
  try {
    const cached = sessionStorage.getItem('ygo_deck_cache');
    if(cached) {
      DECK_BASE = JSON.parse(cached);
      if(DECK_BASE.length >= 4) {
        document.getElementById('loadingTxt').textContent = `${DECK_BASE.length} cartes (cache) !`;
        document.getElementById('loadingBar').style.width = '100%';
        await sleep(400);
        startGame();
        return;
      }
    }
  } catch(e) {}

  const ok = await fetchCards();
  if(!ok) {
    document.getElementById('loadingTxt').textContent = 'Erreur de chargement ğŸ˜¢';
    return;
  }
  startGame();
}

function startGame() {
  document.getElementById('loading').style.display = 'none';
  deck = shuffle(DECK_BASE);
  renderHUD();
  nextRound();
}

init();
</script>
</body>
</html>
